<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PBL Game ‚Äî Start Your Journey</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--l1:#F37E4C;--l2:#795CDC;--l3:#3C7C54;--green:#4EA72E;--bg:#F5F0E8;--dark:#1A1A2E;}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Syne',sans-serif;background:var(--bg);color:var(--dark);min-height:100vh;overflow-x:hidden;}
.screen{display:none;min-height:100vh;}
.screen.active{display:flex;flex-direction:column;}

/* INTRO */
#screen-intro{align-items:center;justify-content:center;background:var(--dark);position:relative;overflow:hidden;}
#screen-intro::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 15% 55%,rgba(243,126,76,.2) 0%,transparent 45%),radial-gradient(circle at 80% 25%,rgba(121,92,220,.2) 0%,transparent 45%),radial-gradient(circle at 50% 85%,rgba(60,124,84,.2) 0%,transparent 45%);}
.intro-inner{text-align:center;position:relative;z-index:1;padding:40px 24px;}
.intro-eyebrow{font-family:'Space Mono',monospace;font-size:10px;letter-spacing:5px;color:var(--green);text-transform:uppercase;margin-bottom:20px;opacity:0;animation:fadeUp .5s ease forwards .2s;}
.intro-title{font-size:clamp(72px,14vw,130px);font-weight:800;color:#fff;line-height:.85;letter-spacing:-5px;opacity:0;animation:fadeUp .5s ease forwards .35s;}
.intro-game{font-size:clamp(18px,3.5vw,32px);font-weight:400;letter-spacing:6px;color:rgba(255,255,255,.3);margin:10px 0 44px;opacity:0;animation:fadeUp .5s ease forwards .5s;}
.line-pills{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-bottom:48px;opacity:0;animation:fadeUp .5s ease forwards .65s;}
.pill{padding:6px 18px;border-radius:100px;font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:white;}
.pill-1{background:var(--l1);}.pill-2{background:var(--l2);}.pill-3{background:var(--l3);}
.intro-btns{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;opacity:0;animation:fadeUp .5s ease forwards .8s;}
.btn-cta{background:var(--green);color:white;border:none;padding:18px 52px;font-family:'Syne',sans-serif;font-size:16px;font-weight:700;letter-spacing:2px;text-transform:uppercase;border-radius:6px;cursor:pointer;transition:all .2s;}
.btn-cta:hover{transform:translateY(-3px);box-shadow:0 10px 28px rgba(78,167,46,.45);}
.btn-ghost{background:rgba(255,255,255,.08);color:rgba(255,255,255,.7);border:none;padding:18px 32px;font-family:'Syne',sans-serif;font-size:14px;font-weight:600;letter-spacing:1px;border-radius:6px;cursor:pointer;transition:all .2s;}
.btn-ghost:hover{background:rgba(255,255,255,.14);}

/* SETUP */
#screen-setup{align-items:center;justify-content:center;padding:40px 20px;}
.setup-card{background:white;border-radius:20px;padding:48px 40px;max-width:460px;width:100%;box-shadow:0 4px 40px rgba(0,0,0,.09);}
.setup-card h2{font-size:30px;font-weight:800;margin-bottom:6px;}
.setup-sub{font-family:'Space Mono',monospace;font-size:11px;color:rgba(0,0,0,.4);margin-bottom:36px;}
.field{margin-bottom:20px;}
.field label{display:block;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:rgba(0,0,0,.45);margin-bottom:8px;}
.field input{width:100%;padding:14px 16px;border:2px solid #EBEBEB;border-radius:10px;font-family:'Syne',sans-serif;font-size:16px;font-weight:600;outline:none;transition:border-color .2s;}
.field input:focus{border-color:var(--green);}
.field-row{display:flex;gap:12px;align-items:flex-start;}
.field-row .field{flex:1;}
.timer-hint{font-family:'Space Mono',monospace;font-size:10px;color:rgba(0,0,0,.35);line-height:1.75;padding-top:34px;}
.btn-launch{background:var(--dark);color:white;border:none;padding:17px 32px;font-family:'Syne',sans-serif;font-size:15px;font-weight:700;letter-spacing:1px;border-radius:10px;cursor:pointer;width:100%;transition:all .2s;margin-top:8px;}
.btn-launch:hover{background:var(--green);transform:translateY(-1px);}

/* GAME */
#screen-game{flex-direction:row;height:100vh;overflow:hidden;}
.sidebar{width:220px;min-width:220px;background:var(--dark);color:white;padding:20px 14px;display:flex;flex-direction:column;gap:4px;overflow-y:auto;}
.sb-logo{font-size:17px;font-weight:800;letter-spacing:-1px;margin-bottom:2px;}
.sb-logo span{display:block;font-family:'Space Mono',monospace;font-size:8px;letter-spacing:3px;color:rgba(255,255,255,.28);margin-top:2px;}
.sb-div{height:1px;background:rgba(255,255,255,.07);margin:10px 0;}
.sb-label{font-family:'Space Mono',monospace;font-size:8px;letter-spacing:3px;text-transform:uppercase;color:rgba(255,255,255,.28);padding:4px 8px;}
.sb-group{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;background:rgba(255,255,255,.06);margin-bottom:4px;}
.sb-group-dot{width:10px;height:10px;border-radius:50%;background:var(--green);}
.sb-group-name{font-size:14px;font-weight:700;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.lp-item{padding:10px;border-radius:10px;margin-bottom:4px;transition:all .2s;}
.lp-item.active-line{background:rgba(255,255,255,.07);}
.lp-top{display:flex;align-items:center;gap:8px;margin-bottom:6px;}
.lp-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.lp-name{font-size:12px;font-weight:700;flex:1;}
.lp-lock{font-size:10px;}
.lp-bar-bg{height:4px;background:rgba(255,255,255,.1);border-radius:100px;overflow:hidden;}
.lp-bar-fill{height:100%;border-radius:100px;transition:width .5s ease;}
.lp-count{font-family:'Space Mono',monospace;font-size:9px;color:rgba(255,255,255,.3);margin-top:4px;}
.sb-timer{background:rgba(255,255,255,.05);border-radius:12px;padding:14px 12px;text-align:center;margin:8px 0;}
.sb-timer-label{font-family:'Space Mono',monospace;font-size:8px;letter-spacing:3px;color:rgba(255,255,255,.3);margin-bottom:6px;text-transform:uppercase;}
.sb-timer-val{font-family:'Space Mono',monospace;font-size:30px;font-weight:700;color:white;letter-spacing:3px;}
.sb-timer-val.warn{color:#F37E4C;}.sb-timer-val.danger{color:#E74C3C;}
.sb-timer-sub{font-size:10px;color:rgba(255,255,255,.28);margin-top:4px;}
.sb-btns{margin-top:auto;display:flex;flex-direction:column;gap:8px;}
.btn-sb{padding:12px;border-radius:8px;border:none;font-family:'Syne',sans-serif;font-size:12px;font-weight:700;letter-spacing:1px;cursor:pointer;transition:all .2s;text-align:center;}
.btn-green{background:var(--green);color:white;}.btn-green:hover{filter:brightness(1.1);}
.btn-muted{background:rgba(255,255,255,.07);color:rgba(255,255,255,.55);}.btn-muted:hover{background:rgba(255,255,255,.12);color:white;}

/* BOARD */
.board-wrap{flex:1;display:flex;flex-direction:column;overflow:hidden;background:var(--bg);}
.board-topbar{padding:12px 24px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(0,0,0,.06);flex-shrink:0;}
.topbar-badge{display:flex;align-items:center;gap:8px;padding:7px 18px;border-radius:100px;color:white;font-size:12px;font-weight:700;}
.topbar-hint{font-family:'Space Mono',monospace;font-size:10px;color:rgba(0,0,0,.38);margin-left:12px;}
.topbar-left{display:flex;align-items:center;}
.btn-instr{background:white;border:1.5px solid #E0E0E0;color:var(--dark);border-radius:100px;padding:7px 18px;font-family:'Syne',sans-serif;font-size:12px;font-weight:700;cursor:pointer;transition:all .2s;}
.btn-instr:hover{border-color:var(--dark);}
.board-svg-wrap{flex:1;overflow:hidden;}
#board-svg{width:100%;height:100%;}

/* CARD MODAL */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.72);backdrop-filter:blur(6px);z-index:200;display:none;align-items:center;justify-content:center;padding:20px;}
.overlay.open{display:flex;}
.modal-card{background:white;border-radius:22px;max-width:520px;width:100%;overflow:hidden;box-shadow:0 40px 100px rgba(0,0,0,.35);animation:pop .38s cubic-bezier(.34,1.56,.64,1) forwards;}
@keyframes pop{from{transform:scale(.82) translateY(24px);opacity:0}to{transform:scale(1) translateY(0);opacity:1}}
.mc-top{padding:20px 24px 18px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #F0F0F0;}
.mc-tag{font-family:'Space Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;font-weight:700;color:white;padding:5px 14px;border-radius:100px;}
.mc-station{font-family:'Space Mono',monospace;font-size:10px;color:rgba(0,0,0,.32);letter-spacing:1px;}
.mc-body{padding:22px 24px 26px;}
.mc-q{font-size:21px;font-weight:700;line-height:1.38;margin-bottom:20px;}
.mc-sep{height:1px;background:#F0F0F0;margin-bottom:18px;}
.mc-pill-label{font-family:'Space Mono',monospace;font-size:8px;letter-spacing:3px;text-transform:uppercase;color:rgba(0,0,0,.32);margin-bottom:6px;}
.mc-concept{font-size:13px;font-weight:700;padding:8px 14px;border-radius:8px;display:inline-block;margin-bottom:16px;}
.mc-goal{font-size:13px;line-height:1.65;color:rgba(0,0,0,.55);margin-bottom:22px;}
.mc-notepad{background:#FFFDF0;border:1.5px solid #EEE090;border-radius:10px;padding:12px 14px;margin-bottom:22px;}
.mc-notepad-lbl{font-family:'Space Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:rgba(0,0,0,.32);margin-bottom:6px;}
.mc-notepad textarea{width:100%;border:none;background:transparent;resize:none;font-family:'Syne',sans-serif;font-size:13px;color:var(--dark);outline:none;min-height:56px;line-height:1.6;}
.mc-actions{display:flex;gap:10px;}
.btn-skip{flex:1;padding:13px;border:2px solid #EBEBEB;background:none;border-radius:10px;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;}
.btn-skip:hover{border-color:#bbb;}
.btn-ans{flex:2;padding:13px;border:none;border-radius:10px;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;color:white;cursor:pointer;transition:all .2s;}
.btn-ans:hover{filter:brightness(1.1);transform:translateY(-1px);}
/* CARD PICKER */
.picker-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(6px);z-index:200;display:none;align-items:center;justify-content:center;padding:20px;}
.picker-overlay.open{display:flex;}
.picker-box{background:white;border-radius:22px;max-width:680px;width:100%;max-height:88vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 40px 100px rgba(0,0,0,.35);animation:pop .38s cubic-bezier(.34,1.56,.64,1) forwards;}
.picker-head{padding:20px 24px 18px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #F0F0F0;flex-shrink:0;}
.picker-head-left{display:flex;align-items:center;gap:10px;}
.picker-tag{font-family:'Space Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;font-weight:700;color:white;padding:5px 14px;border-radius:100px;}
.picker-count{font-family:'Space Mono',monospace;font-size:10px;color:rgba(0,0,0,.35);}
.btn-close-picker{background:#F5F5F5;border:none;color:#666;width:32px;height:32px;border-radius:50%;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .2s;flex-shrink:0;}
.btn-close-picker:hover{background:#E8E8E8;}
.picker-grid{padding:16px 20px 20px;overflow-y:auto;display:grid;grid-template-columns:1fr 1fr;gap:10px;}
@media(max-width:600px){.picker-grid{grid-template-columns:1fr;}}
.picker-card{border:1.5px solid #EBEBEB;border-radius:14px;padding:14px 16px;cursor:pointer;transition:all .2s;position:relative;background:white;}
.picker-card:hover{border-color:var(--card-accent);transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.08);}
.picker-card.done{background:#F8F8F8;opacity:.5;cursor:default;pointer-events:none;}
.picker-card-num{font-family:'Space Mono',monospace;font-size:8px;letter-spacing:2px;color:rgba(0,0,0,.3);margin-bottom:6px;}
.picker-card-q{font-size:13px;font-weight:600;line-height:1.45;color:var(--dark);margin-bottom:10px;}
.picker-card-concept{font-size:10px;font-weight:700;padding:4px 10px;border-radius:100px;display:inline-block;}
.picker-card-done-badge{position:absolute;top:10px;right:10px;font-size:10px;font-weight:700;color:white;padding:3px 8px;border-radius:100px;}

/* TIME UP OVERLAY */
.timeup-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(8px);z-index:250;display:none;align-items:center;justify-content:center;padding:20px;}
.timeup-overlay.open{display:flex;}
.timeup-box{text-align:center;animation:pop .4s cubic-bezier(.34,1.56,.64,1) forwards;max-width:420px;}
.timeup-icon{font-size:64px;margin-bottom:20px;}
.timeup-title{font-size:clamp(28px,6vw,48px);font-weight:800;color:white;letter-spacing:-2px;margin-bottom:8px;}
.timeup-sub{font-family:'Space Mono',monospace;font-size:11px;letter-spacing:2px;color:rgba(255,255,255,.4);margin-bottom:32px;line-height:1.9;}
.timeup-badge{display:inline-flex;align-items:center;gap:10px;padding:12px 28px;border-radius:100px;color:white;font-size:15px;font-weight:700;margin-bottom:32px;}
.timeup-btns{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;}
.btn-timeup-next{background:var(--green);color:white;border:none;padding:15px 36px;border-radius:8px;font-family:'Syne',sans-serif;font-size:14px;font-weight:700;cursor:pointer;letter-spacing:1px;transition:all .2s;}
.btn-timeup-next:hover{filter:brightness(1.1);transform:translateY(-1px);}
.btn-timeup-stay{background:rgba(255,255,255,.1);color:rgba(255,255,255,.7);border:none;padding:15px 28px;border-radius:8px;font-family:'Syne',sans-serif;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;}
.btn-timeup-stay:hover{background:rgba(255,255,255,.18);color:white;}

/* END */
#screen-end{align-items:center;justify-content:center;background:var(--dark);text-align:center;padding:40px;}
.end-emoji{font-size:72px;margin-bottom:24px;animation:bob 1.2s ease infinite alternate;}
@keyframes bob{from{transform:translateY(0)}to{transform:translateY(-14px)}}
.end-title{font-size:clamp(36px,7vw,64px);font-weight:800;color:white;letter-spacing:-2px;margin-bottom:8px;}
.end-group{font-size:clamp(20px,4vw,36px);font-weight:800;margin-bottom:12px;}
.end-sub{font-family:'Space Mono',monospace;font-size:11px;color:rgba(255,255,255,.3);letter-spacing:2px;margin-bottom:40px;line-height:1.9;}
.btn-restart{background:var(--green);color:white;border:none;padding:16px 44px;border-radius:8px;font-family:'Syne',sans-serif;font-size:15px;font-weight:700;cursor:pointer;letter-spacing:1px;transition:all .2s;}
.btn-restart:hover{filter:brightness(1.1);transform:translateY(-2px);}

.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(70px);background:var(--dark);color:white;padding:13px 28px;border-radius:100px;font-size:13px;font-weight:600;z-index:500;transition:transform .3s cubic-bezier(.34,1.56,.64,1);white-space:nowrap;pointer-events:none;}
.toast.show{transform:translateX(-50%) translateY(0);}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
/* HOVER TOOLTIP */
.stn-tooltip{
  position:fixed;z-index:150;pointer-events:none;
  background:var(--dark);color:white;
  border-radius:12px;padding:12px 16px;
  max-width:260px;min-width:160px;
  box-shadow:0 8px 32px rgba(0,0,0,.28);
  transition:opacity .15s ease, transform .15s ease;
  opacity:0;transform:translateY(6px);
}
.stn-tooltip.visible{opacity:1;transform:translateY(0);}
.stn-tooltip-line{font-family:'Space Mono',monospace;font-size:8px;letter-spacing:3px;text-transform:uppercase;margin-bottom:6px;opacity:.6;}
.stn-tooltip-q{font-size:12px;font-weight:600;line-height:1.5;}
.stn-tooltip-hint{font-family:'Space Mono',monospace;font-size:9px;color:rgba(255,255,255,.35);margin-top:8px;}
.stn-tooltip-done{font-size:11px;color:rgba(255,255,255,.45);font-style:italic;}

</style>
</head>
<body>

<!-- INTRO -->
<div id="screen-intro" class="screen active">
  <div class="intro-inner">
    <div class="intro-eyebrow">IT:U ¬∑ Center for Project-Based Learning</div>
    <div class="intro-title">PBL</div>
    <div class="intro-game">GAME ¬∑ START YOUR JOURNEY</div>
    <div class="line-pills">
      <div class="pill pill-1">LINE 1 ¬∑ Get to Know Each Other</div>
      <div class="pill pill-2">LINE 2 ¬∑ Individual Learning</div>
      <div class="pill pill-3">LINE 3 ¬∑ Team Learning</div>
    </div>
    <div class="intro-btns">
      <button class="btn-cta" onclick="showScreen('setup')">Start Your Journey ‚Üí</button>
    </div>
  </div>
</div>

<!-- SETUP -->
<div id="screen-setup" class="screen">
  <div class="setup-card">
    <h2>Set Up Your Group</h2>
    <p class="setup-sub">One board per group ‚Äî each group plays independently</p>
    <div class="field">
      <label>Group Name</label>
      <input type="text" id="group-name-input" placeholder="e.g. Team 1" maxlength="30">
    </div>
    <div class="field-row">
      <div class="field">
        <label>Minutes per Line</label>
        <input type="number" id="timer-input" value="15" min="1" max="90">
      </div>
      <div class="timer-hint">The moderator sets<br>how long each line<br>will take.</div>
    </div>
    <button class="btn-launch" onclick="startGame()">Launch Game ‚Üí</button>
  </div>
</div>

<!-- GAME -->
<div id="screen-game" class="screen">
  <div class="sidebar">
    <div class="sb-logo">PBL Game<span>Start Your Journey</span></div>
    <div class="sb-div"></div>
    <div class="sb-label">Your Group</div>
    <div class="sb-group">
      <div class="sb-group-dot"></div>
      <div class="sb-group-name" id="sb-group-name">‚Äî</div>
    </div>
    <div class="sb-div"></div>
    <div class="sb-label">Progress</div>
    <div class="lp-item" id="lp-1">
      <div class="lp-top"><div class="lp-dot" style="background:var(--l1)"></div><div class="lp-name">LINE 1</div><div class="lp-lock" id="lp-lock-1"></div></div>
      <div class="lp-bar-bg"><div class="lp-bar-fill" id="lp-bar-1" style="background:var(--l1);width:0%"></div></div>
      <div class="lp-count" id="lp-count-1">0 / 9</div>
    </div>
    <div class="lp-item" id="lp-2">
      <div class="lp-top"><div class="lp-dot" style="background:var(--l2)"></div><div class="lp-name">LINE 2</div><div class="lp-lock" id="lp-lock-2"></div></div>
      <div class="lp-bar-bg"><div class="lp-bar-fill" id="lp-bar-2" style="background:var(--l2);width:0%"></div></div>
      <div class="lp-count" id="lp-count-2">0 / 11</div>
    </div>
    <div class="lp-item" id="lp-3">
      <div class="lp-top"><div class="lp-dot" style="background:var(--l3)"></div><div class="lp-name">LINE 3</div><div class="lp-lock" id="lp-lock-3"></div></div>
      <div class="lp-bar-bg"><div class="lp-bar-fill" id="lp-bar-3" style="background:var(--l3);width:0%"></div></div>
      <div class="lp-count" id="lp-count-3">0 / 12</div>
    </div>
    <div class="sb-div"></div>
    <div class="sb-timer">
      <div class="sb-timer-label">Time Remaining</div>
      <div class="sb-timer-val" id="sb-timer-val">--:--</div>
      <div class="sb-timer-sub" id="sb-timer-sub">‚Äî</div>
    </div>
    <div class="sb-btns">
      <button class="btn-sb btn-green" id="btn-next-line" style="display:none" onclick="advanceLine()">‚Üí Next Line</button>
    </div>
  </div>

  <div class="board-wrap">
    <div class="board-topbar">
      <div class="topbar-left">
        <div class="topbar-badge" id="topbar-badge"></div>
        <div class="topbar-hint" id="topbar-hint"></div>
      </div>
      <button class="btn-instr" onclick="showScreen('intro')" style="font-size:11px;padding:6px 14px;color:rgba(0,0,0,.4);border-color:#E8E8E8;">‚Üê Exit</button>
    </div>
    <div class="board-svg-wrap">
      <svg id="board-svg" viewBox="0 0 820 560" preserveAspectRatio="xMidYMid meet"></svg>
    </div>
  </div>
</div>

<!-- END -->
<div id="screen-end" class="screen">
  <div class="end-emoji">üéâ</div>
  <div class="end-title">Journey Complete!</div>
  <div class="end-group" id="end-group-name" style="color:var(--green)"></div>
  <div class="end-sub">has completed all three lines<br>You now have a shared understanding of PBL</div>
  <button class="btn-restart" onclick="showScreen('intro')">Play Again</button>
</div>


<!-- CARD PICKER -->
<div class="picker-overlay" id="picker-overlay">
  <div class="picker-box">
    <div class="picker-head">
      <div class="picker-head-left">
        <div class="picker-tag" id="picker-tag"></div>
        <div class="picker-count" id="picker-count"></div>
      </div>
      <button class="btn-close-picker" onclick="closePicker()">‚úï</button>
    </div>
    <div class="picker-grid" id="picker-grid"></div>
  </div>
</div>
<!-- CARD MODAL -->
<div class="overlay" id="card-overlay">
  <div class="modal-card" id="modal-inner"></div>
</div>

<!-- TIME UP OVERLAY -->
<div class="timeup-overlay" id="timeup-overlay">
  <div class="timeup-box">
    <div class="timeup-icon">‚è∞</div>
    <div class="timeup-title" id="timeup-title">Time's Up!</div>
    <div class="timeup-sub" id="timeup-sub"></div>
    <div class="timeup-badge" id="timeup-badge"></div>
    <div class="timeup-btns">
      <button class="btn-timeup-stay" onclick="closeTimeUp()">Stay on this line</button>
      <button class="btn-timeup-next" id="btn-timeup-next" onclick="advanceLineFromTimeUp()">Move to Next Line ‚Üí</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<div class="stn-tooltip" id="stn-tooltip"><div class="stn-tooltip-line" id="stn-tooltip-line"></div><div class="stn-tooltip-q" id="stn-tooltip-q"></div><div class="stn-tooltip-hint" id="stn-tooltip-hint"></div></div>


<script>
const LINE_META={
  1:{name:'Get to Know Each Other',color:'#F37E4C',label:'LINE 1'},
  2:{name:'Individual Learning',color:'#795CDC',label:'LINE 2'},
  3:{name:'Team Learning',color:'#3C7C54',label:'LINE 3'}
};
const CARDS={
  1:[
    {q:'Introduce yourself to the group.',concept:'Psychological Safety & Belonging',goal:'Build connections ‚Äî helps participants get to know each other.'},
    {q:'What is your research or academic background?',concept:'Interdisciplinary Awareness & Identity',goal:'Understand backgrounds ‚Äî provides insight into each person\'s expertise.'},
    {q:'What motivated you to enter your discipline? Was it planned or a happy accident?',concept:'Interdisciplinary Awareness & Identity',goal:'Explore motivations ‚Äî shares personal stories behind career choices.'},
    {q:'What\'s one thing about your field that you wish more people understood?',concept:'Interdisciplinary Awareness & Identity',goal:'Promote awareness ‚Äî highlights key insights from different fields.'},
    {q:'If you had to explain your field to a child in one sentence, how would you do it?',concept:'Interdisciplinary Awareness & Identity',goal:'Simplify complexity ‚Äî encourages clear and accessible communication.'},
    {q:'What\'s a skill or knowledge area from another discipline you wish you had or admire?',concept:'Interdisciplinary Awareness & Identity',goal:'Foster interdisciplinary appreciation ‚Äî recognizes valuable skills from other disciplines.'},
    {q:'What\'s the most exciting interdisciplinary project you\'ve worked on?',concept:'Authentic & Experiential Learning',goal:'Encourage collaboration ‚Äî shares experiences of working across disciplines.'},
    {q:'What motivated you to change your discipline and join IT:U?',concept:'Psychological Safety & Belonging',goal:'Explore motivation for IT:U and working interdisciplinarily.'},
    {q:'What\'s a skill from your discipline that you are proud of and bring to the table?',concept:'Interdisciplinary Awareness & Identity',goal:'Interdisciplinary appreciation ‚Äî recognizing benefits due to complementarity.'},
  ],
  2:[
    {q:'What strategies do you use to stay motivated when learning something new?',concept:'Self-Regulated Learning (SRL)',goal:'Understand motivation ‚Äî identifies what drives individuals to stay engaged.'},
    {q:'How do you plan and manage your time when preparing for a big project or deadline?',concept:'Self-Regulated Learning (SRL)',goal:'Explore time management ‚Äî reveals strategies for organizing work efficiently.'},
    {q:'When you get stuck on a difficult problem or concept, what do you usually do?',concept:'Self-Regulated Learning (SRL)',goal:'Assess problem-solving approaches ‚Äî uncovers strategies for overcoming learning obstacles.'},
    {q:'Can you think of a time when you adjusted your study methods to improve your learning? What was the trigger?',concept:'Metacognition & Reflection',goal:'Encourage reflection on learning adaptation ‚Äî highlights self-awareness and ability to refine techniques.'},
    {q:'How do you adapt your learning approach when faced with a subject that doesn\'t come naturally to you?',concept:'Self-Regulated Learning (SRL)',goal:'Analyze learning flexibility ‚Äî examines how individuals adjust their approach to challenging topics.'},
    {q:'How do you usually learn from teammates who have a different approach or background?',concept:'Co-Regulation & Peer Learning',goal:'Bridge individual learning to team learning ‚Äî connects personal style to collaborative PBL context.'},
    {q:'When managing multiple projects or learning goals, how do you prioritize tasks while ensuring deep understanding?',concept:'Self-Regulated Learning (SRL)',goal:'Evaluate prioritization and deep learning strategies.'},
    {q:'How do you integrate feedback ‚Äî from peers, mentors, or self-reflection ‚Äî into your learning process?',concept:'Co-Regulation & Peer Learning',goal:'Highlight the role of feedback in growth ‚Äî demonstrates how input influences learning.'},
    {q:'How do you usually coordinate team and individual goals? What are your strategies to coordinate vested interests?',concept:'Socially Shared Regulated Learning (SSRL)',goal:'Bridge individual learning to team learning ‚Äî connects personal agendas to collaborative PBL context.'},
    {q:'What are your expectations for working interdisciplinarily? What strategies do you apply?',concept:'Socially Shared Regulated Learning (SSRL)',goal:'Interdisciplinary collaboration ‚Äî experiences and strategies.'},
    {q:'What are your expectations for working, learning and innovating in teams? How do you deal with team learning and communication?',concept:'Socially Shared Regulated Learning (SSRL)',goal:'Collaboration ‚Äî experiences and strategies; socially shared regulated learning.'},
  ],
  3:[
    {q:'Have you ever worked on a project requiring knowledge from multiple disciplines? How did combining perspectives impact your learning?',concept:'Authentic & Experiential Learning',goal:'Encourage interdisciplinary thinking ‚Äî explores how integrating diverse knowledge enhances learning.'},
    {q:'How do you feel about using a digital portfolio to showcase your learning and projects?',concept:'Metacognition & Reflection',goal:'Assess reflection and presentation of learning ‚Äî examines attitudes toward documenting experiences.'},
    {q:'PBL involves collaboration with industry and academia. What kinds of real-world projects would you be most excited to work on?',concept:'Authentic & Experiential Learning',goal:'Connect learning to real-world applications ‚Äî identifies interests and motivations.'},
    {q:'Would you be open to sharing your work and collaborating with a broader learning community? What would make you more willing?',concept:'Psychological Safety & Belonging',goal:'Explore openness to knowledge sharing ‚Äî investigates willingness to engage in broader learning networks.'},
    {q:'Reflecting on a past project, what was the most valuable lesson ‚Äî not just academically, but in terms of teamwork or adaptability?',concept:'Transversal Skills Development',goal:'Highlight personal and professional growth ‚Äî encourages reflection on key skills gained beyond academics.'},
    {q:'What do you expect from a team PBL coach during a project? How would their support ideally look?',concept:'Team Regulation & Collaboration Contract',goal:'Align coaching expectations ‚Äî surfaces mental models of coaching and prepares for the coach/facilitator role.'},
    {q:'Think of a time you worked in a team where things didn\'t go as planned. What ground rules could have helped?',concept:'Team Regulation & Collaboration Contract',goal:'Prepare for the Collaboration Contract ‚Äî connects real experience to the need for explicit team agreements.'},
    {q:'When working in teams, how do you handle situations where someone is not contributing or there is unconstructive conflict?',concept:'Team Regulation & Collaboration Contract',goal:'Explore team regulation and conflict resolution ‚Äî addresses teamwork dynamics.'},
    {q:'What tools have you used to manage projects or track team progress (e.g., Gantt charts, Kanban boards)?',concept:'Project Management Literacy',goal:'Map prior experience with PM tools ‚Äî prepares for Lucidchart and Gantt tools in the course.'},
    {q:'Which transversal skills (teamwork, communication, adaptability, critical thinking) do you find most challenging to develop?',concept:'Transversal Skills Development',goal:'Identify transversal skill development priorities ‚Äî helps coaches focus on specific skills.'},
    {q:'How do you think regular check-ins with a coach could support your team\'s learning process?',concept:'Co-Regulation & Peer Learning',goal:'Introduce coaching process/structure ‚Äî opens discussion about recurring meeting structure.'},
    {q:'Have you ever participated in project-based learning or worked on an industry project? What are your lessons learned?',concept:'Authentic & Experiential Learning',goal:'PBL approach ‚Äî experiences and strategies; active learning in teams.'},
  ]
};
const STATIONS={
  1:[{id:'1-1',x:80,y:460,n:1},{id:'1-2',x:80,y:360,n:2},{id:'1-3',x:80,y:260,n:3},{id:'1-4',x:160,y:180,n:4},{id:'1-5',x:260,y:140,n:5},{id:'1-6',x:360,y:140,n:6},{id:'1-7',x:460,y:140,n:7},{id:'1-8',x:540,y:180,n:8},{id:'1-9',x:580,y:260,n:9,isEnd:true}],
  2:[{id:'2-1',x:80,y:280,n:1},{id:'2-2',x:160,y:280,n:2},{id:'2-3',x:260,y:280,n:3},{id:'2-4',x:360,y:280,n:4},{id:'2-5',x:460,y:280,n:5},{id:'2-6',x:560,y:280,n:6},{id:'2-7',x:660,y:280,n:7},{id:'2-8',x:740,y:340,n:8},{id:'2-9',x:740,y:420,n:9},{id:'2-10',x:660,y:460,n:10},{id:'2-11',x:560,y:460,n:11,isEnd:true}],
  3:[{id:'3-1',x:80,y:100,n:1},{id:'3-2',x:180,y:100,n:2},{id:'3-3',x:280,y:100,n:3},{id:'3-4',x:380,y:100,n:4},{id:'3-5',x:480,y:100,n:5},{id:'3-6',x:580,y:100,n:6},{id:'3-7',x:680,y:100,n:7},{id:'3-8',x:760,y:160,n:8},{id:'3-9',x:760,y:260,n:9},{id:'3-10',x:760,y:360,n:10},{id:'3-11',x:680,y:440,n:11},{id:'3-12',x:580,y:460,n:12,isEnd:true}]
};

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let groupName='', minutesPerLine=15, currentLine=1;
// ‚îÄ‚îÄ GOOGLE SHEETS ‚îÄ‚îÄ replace with your own Apps Script URL
const SHEETS_URL = 'https://script.google.com/macros/s/AKfycbxBMht7NIG4iVLXOnmKVEEszmFaUWRimQN4507mJRraMfU--ACk1yq3PSXk-ew3Ggm6MQ/exec';
let sessionId = Date.now().toString(36) + Math.random().toString(36).slice(2,6);
let completed={1:[],2:[],3:[]};
let timerInterval=null, secondsLeft=0;
let activeStationData=null;

// ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ
function showScreen(n){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('screen-'+n).classList.add('active');
  if(n==='setup') setTimeout(()=>document.getElementById('group-name-input').focus(),100);
}

function startGame(){
  groupName=document.getElementById('group-name-input').value.trim()||'Team 1';
  minutesPerLine=parseInt(document.getElementById('timer-input').value)||15;
  currentLine=1; completed={1:[],2:[],3:[]};
  showScreen('game');
  document.getElementById('sb-group-name').textContent=groupName;
  document.getElementById('end-group-name').textContent=groupName;
  updateSidebar(); startTimer(); renderBoard(); updateTopbar();
}

// ‚îÄ‚îÄ TIMER ‚îÄ‚îÄ
function startTimer(){
  clearInterval(timerInterval);
  secondsLeft=minutesPerLine*60;
  renderTimer();
  timerInterval=setInterval(()=>{
    secondsLeft--;
    renderTimer();
    if(secondsLeft<=0){
      clearInterval(timerInterval);
      showTimeUp();
    }
  },1000);
}

function renderTimer(){
  const m=Math.floor(secondsLeft/60), s=secondsLeft%60;
  const el=document.getElementById('sb-timer-val');
  el.textContent=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  el.className='sb-timer-val';
  if(secondsLeft<=60) el.classList.add('danger');
  else if(secondsLeft<=180) el.classList.add('warn');
  document.getElementById('sb-timer-sub').textContent=LINE_META[currentLine].label;
}

// ‚îÄ‚îÄ TIME UP ‚îÄ‚îÄ
function showTimeUp(){
  const next=currentLine+1;
  const title=document.getElementById('timeup-title');
  const sub=document.getElementById('timeup-sub');
  const badge=document.getElementById('timeup-badge');
  const nextBtn=document.getElementById('btn-timeup-next');

  title.textContent=`Time's up on ${LINE_META[currentLine].label}!`;

  if(currentLine<3){
    sub.textContent=`You've completed ${completed[currentLine].length} station${completed[currentLine].length!==1?'s':''} on ${LINE_META[currentLine].label}.\nMove on to ${LINE_META[next].label} or stay to finish more.`;
    badge.style.background=LINE_META[next].color;
    badge.textContent=`Next: ${LINE_META[next].label} ¬∑ ${LINE_META[next].name}`;
    nextBtn.style.display='inline-block';
  } else {
    sub.textContent=`You've reached the end of the journey!`;
    badge.style.background=LINE_META[3].color;
    badge.textContent=`${LINE_META[3].label} ¬∑ ${LINE_META[3].name}`;
    nextBtn.style.display='none';
  }
  document.getElementById('timeup-overlay').classList.add('open');
}

function closeTimeUp(){
  document.getElementById('timeup-overlay').classList.remove('open');
  // restart timer for remaining time on same line (give 5 more minutes)
  secondsLeft=5*60;
  timerInterval=setInterval(()=>{secondsLeft--;renderTimer();if(secondsLeft<=0){clearInterval(timerInterval);showTimeUp();}},1000);
  renderTimer();
  showToast('5 more minutes added!');
}

function advanceLineFromTimeUp(){
  document.getElementById('timeup-overlay').classList.remove('open');
  if(currentLine<3){
    currentLine++;
    startTimer();
    updateSidebar();
    updateTopbar();
    renderBoard();
    showToast(`Now on ${LINE_META[currentLine].label}!`);
  } else {
    clearInterval(timerInterval);
    showScreen('end');
  }
}

// ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ
function updateSidebar(){
  [1,2,3].forEach(l=>{
    const total=CARDS[l].length, done=completed[l].length, pct=total>0?(done/total*100):0;
    document.getElementById(`lp-bar-${l}`).style.width=pct+'%';
    document.getElementById(`lp-count-${l}`).textContent=`${done} / ${total}`;
    document.getElementById(`lp-lock-${l}`).textContent=l===currentLine?'‚ñ∂':'';
    const item=document.getElementById(`lp-${l}`);
    item.classList.toggle('active-line',l===currentLine);
  });
}

function updateTopbar(){
  const meta=LINE_META[currentLine];
  const badge=document.getElementById('topbar-badge');
  badge.style.background=meta.color;
  badge.textContent=`${meta.label} ¬∑ ${meta.name}`;
  const done=completed[currentLine].length, total=CARDS[currentLine].length;
  document.getElementById('topbar-hint').textContent=`${total-done} station${total-done!==1?'s':''} remaining`;
}

// ‚îÄ‚îÄ BOARD ‚îÄ‚îÄ
function renderBoard(){
  const svg=document.getElementById('board-svg');
  svg.innerHTML=`<defs><pattern id="dots" width="28" height="28" patternUnits="userSpaceOnUse"><circle cx="14" cy="14" r="1" fill="rgba(0,0,0,0.07)"/></pattern></defs><rect width="820" height="560" fill="url(#dots)"/>`;

  [1,2,3].forEach(line=>{
    const stns=STATIONS[line], meta=LINE_META[line];
    const isActive=line===currentLine;

    // Track line
    const path=document.createElementNS('http://www.w3.org/2000/svg','polyline');
    path.setAttribute('points',stns.map(s=>`${s.x},${s.y}`).join(' '));
    path.setAttribute('fill','none'); path.setAttribute('stroke',meta.color);
    path.setAttribute('stroke-width','4'); path.setAttribute('stroke-linecap','round');
    path.setAttribute('stroke-linejoin','round');
    path.setAttribute('opacity',isActive?'0.8':'0.35');
    svg.appendChild(path);

    // Line label
    const lbl=document.createElementNS('http://www.w3.org/2000/svg','text');
    lbl.setAttribute('x',stns[0].x-38); lbl.setAttribute('y',stns[0].y+4);
    lbl.setAttribute('text-anchor','middle'); lbl.setAttribute('font-family','Space Mono, monospace');
    lbl.setAttribute('font-size','9'); lbl.setAttribute('font-weight','700');
    lbl.setAttribute('letter-spacing','1'); lbl.setAttribute('fill',meta.color);
    lbl.setAttribute('opacity',isActive?'1':'0.45');
    lbl.textContent=`L${line}`;
    svg.appendChild(lbl);

    // Stations
    stns.forEach((stn,idx)=>{
      const card=CARDS[line][idx];
      const isDone=completed[line].includes(stn.id);
      // ALL stations on ALL lines are clickable ‚Äî no locking
      const clickable=!isDone;

      const g=document.createElementNS('http://www.w3.org/2000/svg','g');
      g.setAttribute('opacity',isActive?'1':'0.45');
      if(clickable){ g.setAttribute('cursor','pointer'); }

      if(clickable){
        const pulse=document.createElementNS('http://www.w3.org/2000/svg','circle');
        pulse.setAttribute('cx',stn.x); pulse.setAttribute('cy',stn.y);
        pulse.setAttribute('r','20'); pulse.setAttribute('fill',meta.color);
        pulse.setAttribute('opacity','0');
        g.addEventListener('mouseenter',(e)=>{
          pulse.setAttribute('opacity','0.13');
          showStationTooltip(e, line, stn, card, false);
          recordHoverStart(stn.id);
        });
        g.addEventListener('mousemove',(e)=>moveTooltip(e));
        g.addEventListener('mouseleave',()=>{
          pulse.setAttribute('opacity','0');
          hideTooltip();
          recordHoverEnd(stn.id);
        });
        g.appendChild(pulse);
        g.addEventListener('click',()=>openPicker(line));
      } else if(isDone){
        g.addEventListener('mouseenter',(e)=>showStationTooltip(e, line, stn, card, true));
        g.addEventListener('mousemove',(e)=>moveTooltip(e));
        g.addEventListener('mouseleave',()=>hideTooltip());
      }

      const r=stn.isEnd?14:10;
      const outer=document.createElementNS('http://www.w3.org/2000/svg','circle');
      outer.setAttribute('cx',stn.x); outer.setAttribute('cy',stn.y); outer.setAttribute('r',r);
      outer.setAttribute('fill',isDone?meta.color:'white');
      outer.setAttribute('stroke',meta.color); outer.setAttribute('stroke-width',stn.isEnd?'3':'2.5');
      g.appendChild(outer);

      if(isDone){
        const t=document.createElementNS('http://www.w3.org/2000/svg','text');
        t.setAttribute('x',stn.x); t.setAttribute('y',stn.y+5); t.setAttribute('text-anchor','middle');
        t.setAttribute('font-size',stn.isEnd?'13':'11'); t.setAttribute('fill','white'); t.textContent='‚úì';
        g.appendChild(t);
      } else {
        const inner=document.createElementNS('http://www.w3.org/2000/svg','circle');
        inner.setAttribute('cx',stn.x); inner.setAttribute('cy',stn.y); inner.setAttribute('r','4');
        inner.setAttribute('fill',meta.color);
        g.appendChild(inner);
      }

      if(stn.isEnd){
        const el=document.createElementNS('http://www.w3.org/2000/svg','text');
        el.setAttribute('x',stn.x+20); el.setAttribute('y',stn.y+5);
        el.setAttribute('font-family','Space Mono, monospace'); el.setAttribute('font-size','9');
        el.setAttribute('font-weight','700'); el.setAttribute('letter-spacing','2');
        el.setAttribute('fill',meta.color); el.textContent='END';
        g.appendChild(el);
      } else {
        const nl=document.createElementNS('http://www.w3.org/2000/svg','text');
        nl.setAttribute('x',stn.x); nl.setAttribute('y',stn.y+r+13);
        nl.setAttribute('text-anchor','middle'); nl.setAttribute('font-family','Space Mono, monospace');
        nl.setAttribute('font-size','8'); nl.setAttribute('fill',meta.color);
        nl.setAttribute('opacity','0.65'); nl.textContent=`S${stn.n}`;
        g.appendChild(nl);
      }
      svg.appendChild(g);
    });
  });

  const wm=document.createElementNS('http://www.w3.org/2000/svg','text');
  wm.setAttribute('x','410'); wm.setAttribute('y','545'); wm.setAttribute('text-anchor','middle');
  wm.setAttribute('font-family','Syne, sans-serif'); wm.setAttribute('font-size','9');
  wm.setAttribute('font-weight','700'); wm.setAttribute('letter-spacing','4');
  wm.setAttribute('fill','rgba(0,0,0,.1)'); wm.textContent='PBL GAME ¬∑ START YOUR JOURNEY ¬∑ IT:U';
  svg.appendChild(wm);
}


// ‚îÄ‚îÄ CARD PICKER ‚îÄ‚îÄ
function openPicker(line){
  const meta = LINE_META[line];
  const cards = CARDS[line];
  const stns = STATIONS[line];

  document.getElementById('picker-tag').textContent = meta.label + ' ¬∑ ' + meta.name;
  document.getElementById('picker-tag').style.background = meta.color;

  const remaining = cards.length - completed[line].length;
  document.getElementById('picker-count').textContent = remaining + ' question' + (remaining!==1?'s':'') + ' remaining';

  const grid = document.getElementById('picker-grid');
  grid.innerHTML = '';

  cards.forEach((card, idx) => {
    const stn = stns[idx];
    const isDone = completed[line].includes(stn.id);

    const div = document.createElement('div');
    div.className = 'picker-card' + (isDone?' done':'');
    div.style.setProperty('--card-accent', meta.color);

    div.innerHTML = `
      <div class="picker-card-num">STATION ${stn.n}</div>
      <div class="picker-card-q">${card.q}</div>
      <div class="picker-card-concept" style="background:${meta.color}18;color:${meta.color}">${card.concept}</div>
      ${isDone ? `<div class="picker-card-done-badge" style="background:${meta.color}">‚úì Done</div>` : ''}
    `;

    if(!isDone){
      div.addEventListener('click', ()=>{
        closePicker();
        openCard(line, stn, card, idx);
      });
    }
    grid.appendChild(div);
  });

  document.getElementById('picker-overlay').classList.add('open');
}

function closePicker(){
  document.getElementById('picker-overlay').classList.remove('open');
}

// ‚îÄ‚îÄ CARD ‚îÄ‚îÄ
function openCard(line,stn,card,idx){
  activeStationData={line,stn,card};
  const meta=LINE_META[line];
  document.getElementById('modal-inner').innerHTML=`
    <div class="mc-top">
      <div class="mc-tag" style="background:${meta.color}">${meta.label} ¬∑ Station ${stn.n}</div>
      <div class="mc-station">Card ${idx+1} of ${CARDS[line].length}</div>
    </div>
    <div class="mc-body">
      <div class="mc-q">${card.q}</div>
      <div class="mc-sep"></div>
      <div class="mc-pill-label">Key Concept</div>
      <div class="mc-concept" style="background:${meta.color}1A;color:${meta.color}">${card.concept}</div>
      <div class="mc-pill-label" style="margin-top:12px">Goal</div>
      <div class="mc-goal">${card.goal}</div>
      <div class="mc-notepad">
        <div class="mc-notepad-lbl">üìù Notes (write on your notepad)</div>
        <textarea placeholder="Take notes while your group discusses‚Ä¶"></textarea>
      </div>
      <div class="mc-actions">
        <button class="btn-skip" onclick="closeCard()">Back</button>
        <button class="btn-ans" style="background:${meta.color}" onclick="completeStation()">Everyone answered ‚úì</button>
      </div>
    </div>`;
  document.getElementById('card-overlay').classList.add('open');
}

function closeCard(){
  document.getElementById('card-overlay').classList.remove('open');
  activeStationData=null;
}

function completeStation(){
  if(!activeStationData) return;
  const{line,stn}=activeStationData;
  if(!completed[line].includes(stn.id)) completed[line].push(stn.id);

  // Capture notes before closing
  const notesEl = document.querySelector('#modal-inner textarea');
  const notes = notesEl ? notesEl.value.trim() : '';

  // Hover data for this station
  const hover = hoverLog[stn.id] || {totalMs:0, sessions:0};

  // Send to Google Sheets
  sendToSheets({
    event: 'station_complete',
    sessionId,
    groupName,
    line: LINE_META[line].label,
    stationId: stn.id,
    stationN: stn.n,
    question: activeStationData.card.q,
    concept: activeStationData.card.concept,
    notes,
    hoverMs: hover.totalMs,
    hoverSessions: hover.sessions,
    timestamp: new Date().toISOString(),
    secondsLeft
  });

  closeCard();
  updateSidebar(); updateTopbar(); renderBoard();

  const allDone=[1,2,3].every(l=>completed[l].length===CARDS[l].length);
  if(allDone){ clearInterval(timerInterval); setTimeout(()=>showScreen('end'),600); return; }

  if(completed[line].length===CARDS[line].length && line<3){
    showLineComplete(line);
    return;
  }

  // Reopen picker so group can choose next question (answered one is now greyed out)
  setTimeout(()=>openPicker(line), 300);
  showToast('‚úì Station complete! Choose the next question.');
}

function showLineComplete(line){
  const meta=LINE_META[line];
  const nextMeta=LINE_META[line+1];
  document.getElementById('modal-inner').innerHTML=`
    <div class="mc-body" style="padding:36px 28px;text-align:center;">
      <div style="font-size:52px;margin-bottom:16px;">üéØ</div>
      <div style="font-size:22px;font-weight:800;margin-bottom:8px;">${meta.label} Complete!</div>
      <div style="font-family:'Space Mono',monospace;font-size:11px;color:rgba(0,0,0,.4);letter-spacing:2px;margin-bottom:20px;">Well done ‚Äî great conversations!</div>
      <div style="background:${meta.color}12;border:1.5px solid ${meta.color}30;border-radius:12px;padding:14px 18px;margin-bottom:24px;font-size:13px;line-height:1.7;color:rgba(0,0,0,.6);">
        You have answered all questions on <strong>${meta.label}</strong>.<br>
        When ready, move your pawn to <strong style="color:${nextMeta.color}">${nextMeta.label} ‚Äî ${nextMeta.name}</strong>.
      </div>
      <button class="btn-ans" style="background:${nextMeta.color};width:100%;" onclick="closeCard();advanceLine();">
        Go to ${nextMeta.label} ‚Üí
      </button>
    </div>`;
  document.getElementById('card-overlay').classList.add('open');
}

function advanceLine(){
  if(currentLine>=3) return;
  const lineFull = completed[currentLine].length === CARDS[currentLine].length;
  currentLine++;
  // Only reset timer if the previous line was fully completed
  if(lineFull){ startTimer(); }
  updateSidebar(); updateTopbar(); renderBoard();
  if(!lineFull){ showToast(`Switched to ${LINE_META[currentLine].label} ‚Äî timer continues`); }
}

function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2800);
}


// ‚îÄ‚îÄ TOOLTIP ‚îÄ‚îÄ
const tooltip = document.getElementById('stn-tooltip');
function showStationTooltip(e, line, stn, card, done){
  const meta = LINE_META[line];
  document.getElementById('stn-tooltip-line').textContent = meta.label;
  document.getElementById('stn-tooltip-line').style.color = meta.color;
  document.getElementById('stn-tooltip-q').textContent = card.q;
  document.getElementById('stn-tooltip-hint').textContent = done ? '‚úì Already answered' : 'Click to open this card';
  document.getElementById('stn-tooltip-hint').style.color = done ? meta.color : 'rgba(255,255,255,.35)';
  tooltip.classList.add('visible');
  positionTooltip(e);
}
function moveTooltip(e){ positionTooltip(e); }
function positionTooltip(e){
  const x = e.clientX, y = e.clientY;
  const tw = 270, th = 100;
  const vw = window.innerWidth, vh = window.innerHeight;
  let left = x + 16, top = y - 20;
  if(left + tw > vw) left = x - tw - 16;
  if(top + th > vh) top = y - th - 10;
  tooltip.style.left = left + 'px';
  tooltip.style.top = top + 'px';
}
function hideTooltip(){ tooltip.classList.remove('visible'); }

// ‚îÄ‚îÄ HOVER ANALYTICS ‚îÄ‚îÄ
const hoverLog = {};   // stn.id -> { totalMs, sessions, hoverStart }
function recordHoverStart(id){
  if(!hoverLog[id]) hoverLog[id] = {totalMs:0, sessions:0, hoverStart:null};
  hoverLog[id].hoverStart = Date.now();
}
function recordHoverEnd(id){
  if(!hoverLog[id] || !hoverLog[id].hoverStart) return;
  const ms = Date.now() - hoverLog[id].hoverStart;
  hoverLog[id].totalMs += ms;
  hoverLog[id].sessions++;
  hoverLog[id].hoverStart = null;
}
function getHoverAnalytics(){
  // Returns sorted list: most-hovered stations first
  return Object.entries(hoverLog)
    .map(([id, data]) => ({id, totalMs: data.totalMs, sessions: data.sessions, avgMs: data.sessions ? Math.round(data.totalMs/data.sessions) : 0}))
    .sort((a,b) => b.totalMs - a.totalMs);
}
// Expose for Google Sheets integration later
window.getHoverAnalytics = getHoverAnalytics;

// ‚îÄ‚îÄ SEND TO GOOGLE SHEETS ‚îÄ‚îÄ
function sendToSheets(data){
  if(!SHEETS_URL || SHEETS_URL==='YOUR_APPS_SCRIPT_URL_HERE') return; // not configured yet
  fetch(SHEETS_URL, {
    method:'POST',
    mode:'no-cors',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(data)
  }).catch(()=>{}); // silent fail ‚Äî never block the game
}

// Send session_start when game launches
const _origStartGame = startGame;
startGame = function(){
  _origStartGame();
  sendToSheets({
    event:'session_start',
    sessionId,
    groupName: document.getElementById('group-name-input').value.trim()||'Team 1',
    minutesPerLine: parseInt(document.getElementById('timer-input').value)||15,
    timestamp: new Date().toISOString()
  });
};

document.addEventListener('DOMContentLoaded',()=>showScreen('intro'));
</script>
</body>
</html>
